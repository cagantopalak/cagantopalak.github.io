<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>New Tab</title>

<!-- =======================  GLOBAL STYLES  ======================= -->
<style>
  /*  ----  CSS CUSTOM PROPERTIES  ----  */
  :root {
    --tile-bg: rgba(255, 255, 255, 0.4); /* default tile background */
    --label-color: #ffffff;              /* default label text colour */
  }

  * { box-sizing: border-box; }
  html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; }

  body {
    /* background is swapped at runtime if the user uploaded a custom image */
    background: var(--custom-bg, url('') ) center / cover no-repeat fixed;
    display: flex;
    align-items: flex-start;  /* topâ€‘align container */
    justify-content: center;
    padding-top: 40px;
  }

  /*  ----  GRID LAYOUT  ----  */
  .container {
    display: grid;
    grid-template-columns: repeat(auto-fill, 180px);
    gap: 15px 20px;
    padding: 40px;
    border-radius: 16px;
    justify-content: center;
    width: 100%;
    max-width: 1200px;
  }

  /*  ----  TILE  ----  */
  .wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 180px;
  }

  .tile {
    width: 180px;
    height: 100px;
    border-radius: 16px;
    background: var(--tile-bg);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: grab;
    transition: transform 0.3s ease, background 0.3s ease;
    position: relative;
    user-select: none;
  }

  .tile:hover {
    background: rgba(255,255,255,0.7);
    transform: scale(1.05);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
  }

  .tile img {
    width: 48px;
    height: 48px;
    margin: 0;
  }

  .tile-label {
    width: 100%;
    margin-top: 8px;
    font-size: 13px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--label-color);
    pointer-events: none;
  }

  /*  ----  ADDâ€‘TILE  ----  */
  .add-tile {
    font-size: 40px;
    line-height: 100px;
    font-weight: bold;
    background: rgba(255,255,255,0.2);
    cursor: pointer;
  }

  /*  ----  MODAL  ----  */
  .modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.6);
    z-index: 2000;
  }

  .modal-content {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    min-width: 300px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .modal-content input, .modal-content button {
    padding: 8px;
    font-size: 14px;
  }

  .modal-content button {
    cursor: pointer;
  }

  /*  ----  EDIT BUTTON (topâ€‘right)  ----  */
  #editBtn {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 10px 15px;
    border: none;
    border-radius: 8px;
    background: rgba(255,255,255,0.7);
    cursor: pointer;
    z-index: 2100;
  }

  /*  ----  CONTEXT MENU  ----  */
  .context-menu {
    position: fixed;
    display: none;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    padding: 4px;
    min-width: 120px;
    z-index: 2200;
  }

  .context-menu button {
    background: none;
    border: none;
    padding: 6px 12px;
    width: 100%;
    text-align: left;
    font-size: 14px;
    cursor: pointer;
  }

  .context-menu button:hover { background: #eee; }
</style>
</head>
<body>

  <!--  ========  GRID CONTAINER  ========  -->
  <div class="container" id="tilesContainer"></div>

  <!--  ========  SITE MODAL  ========  -->
  <div class="modal" id="siteModal" aria-hidden="true" role="dialog">
    <div class="modal-content" role="document">
      <h2 id="modalTitle">Add a Site</h2>
      <input id="siteName" placeholder="Site Name" autocomplete="off" />
      <input id="siteURL" placeholder="https://example.com" type="url" />
      <input id="siteIcon" placeholder="Icon URL (optional)" type="url" />
      <button id="saveSite" aria-label="Save site">Save</button>
      <button id="cancelSite" aria-label="Cancel">Cancel</button>
    </div>
  </div>

  <!--  ========  GLOBAL EDIT SETTINGS  ========  -->
  <button id="editBtn" aria-label="Open settings">Edit</button>

  <div class="modal" id="editModal" aria-hidden="true" role="dialog">
    <div class="modal-content" role="document" style="min-width:320px;">
      <h2>Edit Settings</h2>

      <label>Text Colour <input type="color" id="textColorInput" value="#ffffff" /></label>
      <label>Tile Colour <input type="color" id="tileColorInput" value="#ffffff" /></label>
      <label>Background Image <input type="file" id="bgFileInput" accept="image/*" /></label>

      <button id="saveSettingsBtn">Save</button>
      <button id="cancelSettingsBtn">Cancel</button>
      <hr />
      <button id="exportBtn">Export State</button>
      <input type="file" id="importInput" accept=".json" hidden />
      <button id="importBtn">Import State</button>
    </div>
  </div>

  <!--  ========  CUSTOM CONTEXT MENU  ========  -->
  <div class="context-menu" id="ctxMenu">
    <button id="ctxEdit">âœŽ Edit</button>
    <button id="ctxDelete">ðŸ—‘ Delete</button>
  </div>

<!-- =======================  APPLICATION SCRIPT  ======================= -->
<script>
(() => {
  'use strict';

  /* ------------------------------------------------------------------ */
  /*                          CONSTANTS                                 */
  /* ------------------------------------------------------------------ */
  const TILE_STORAGE_KEY   = 'tiles';
  const SETTINGS_KEY       = 'settings';
  const BG_KEY             = 'customBackground';

  const qs   = sel => document.querySelector(sel);
  const qsa  = sel => Array.from(document.querySelectorAll(sel));
  const byId = id  => document.getElementById(id);

  /* ------------------------------------------------------------------ */
  /*                          DOM HANDLES                               */
  /* ------------------------------------------------------------------ */
  const container        = byId('tilesContainer');
  const siteModal        = byId('siteModal');
  const modalTitle       = byId('modalTitle');
  const nameInput        = byId('siteName');
  const urlInput         = byId('siteURL');
  const iconInput        = byId('siteIcon');
  const saveSiteBtn      = byId('saveSite');
  const cancelSiteBtn    = byId('cancelSite');

  const editBtn          = byId('editBtn');
  const editModal        = byId('editModal');
  const textColorInput   = byId('textColorInput');
  const tileColorInput   = byId('tileColorInput');
  const bgFileInput      = byId('bgFileInput');
  const saveSettingsBtn  = byId('saveSettingsBtn');
  const cancelSettingsBtn= byId('cancelSettingsBtn');
  const exportBtn        = byId('exportBtn');
  const importBtn        = byId('importBtn');
  const importInput      = byId('importInput');

  const ctxMenu          = byId('ctxMenu');
  const ctxEditBtn       = byId('ctxEdit');
  const ctxDeleteBtn     = byId('ctxDelete');

  /* ------------------------------------------------------------------ */
  /*                          STATE                                     */
  /* ------------------------------------------------------------------ */
  let links = loadLinks();          // Array<{name,url,icon}>
  let editIndex = null;             // number | null
  let dragStartIndex;               // number | undefined

  /* ------------------------------------------------------------------ */
  /*                          AUDIO BLIPS                               */
  /* ------------------------------------------------------------------ */
  const AudioCtx   = window.AudioContext || window.webkitAudioContext;
  const audioCtx   = new AudioCtx();

  const blip = (freq, dur) => {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc   = audioCtx.createOscillator();
    const gain  = audioCtx.createGain();
    osc.frequency.value = freq;
    gain.gain.value     = 0.06;    // subtle volume
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
    osc.stop(audioCtx.currentTime + dur);
  };
  const hoverSound = () => blip(500, 0.06);
  const clickSound = () => blip(180, 0.08);

  /* ------------------------------------------------------------------ */
  /*                          UTILS                                     */
  /* ------------------------------------------------------------------ */
  const favicon = url => `https://www.google.com/s2/favicons?sz=64&domain_url=${new URL(url).hostname}`;

  function loadLinks() {
    try {
      return JSON.parse(localStorage.getItem(TILE_STORAGE_KEY)) || [];
    } catch {
      return [];
    }
  }

  function saveLinks() {
    localStorage.setItem(TILE_STORAGE_KEY, JSON.stringify(links));
  }

  function getSettings() {
    try {
      return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {};
    } catch {
      return {};
    }
  }

  function saveSettings(settings) {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  }

  function applySettings() {
    const { textColor = '#ffffff', tileColor = 'rgba(255,255,255,0.4)', customBackground } = getSettings();
    document.documentElement.style.setProperty('--label-color', textColor);
    document.documentElement.style.setProperty('--tile-bg',    tileColor);
    if (customBackground) {
      document.body.style.setProperty('--custom-bg', `url('${customBackground}')`);
    }
  }

  /* ------------------------------------------------------------------ */
  /*                          RENDERING                                 */
  /* ------------------------------------------------------------------ */
  function renderTiles() {
    container.innerHTML = '';
    links.forEach((link, i) => container.appendChild(buildTile(link, i)));
    container.appendChild(buildAddButton());
  }

  function buildTile({ name, url, icon }, index) {
    const wrapper = document.createElement('div');
    wrapper.className = 'wrapper';

    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.draggable = true;
    tile.dataset.index = index;

    tile.innerHTML = `
      <a href="${url}" aria-label="${name}" draggable="false">
        <img src="${icon || favicon(url)}" alt="${name} favicon" />
      </a>
    `;

    // Drag & drop events
    tile.addEventListener('dragstart', dragStart);
    tile.addEventListener('dragover', dragOver);
    tile.addEventListener('drop',     drop);

    // Sound events
    tile.addEventListener('mouseenter', hoverSound, { passive: true });
    tile.addEventListener('mousedown',  clickSound, { passive: true });

    // Clickâ€‘through (ignore rightâ€‘click and contextâ€‘menu buttons)
    tile.addEventListener('click', e => {
      if (e.target.closest('.context-menu')) return;
      if (e.button !== 0) return; // only left click
      window.location.href = url;
    });

    // Label
    const label = document.createElement('span');
    label.className = 'tile-label';
    label.textContent = name;

    wrapper.append(tile, label);
    return wrapper;
  }

  function buildAddButton() {
    const btn = document.createElement('div');
    btn.className = 'tile add-tile';
    btn.textContent = '+';
    btn.addEventListener('click', () => openSiteModal());
    btn.addEventListener('mouseenter', hoverSound, { passive: true });
    return btn;
  }

  /* ------------------------------------------------------------------ */
  /*                        SITE MODAL                                  */
  /* ------------------------------------------------------------------ */
  function openSiteModal(edit = false) {
    siteModal.style.display = 'flex';
    modalTitle.textContent  = edit ? 'Edit Site' : 'Add a Site';
    if (!edit) {
      nameInput.value = urlInput.value = iconInput.value = '';
      editIndex = null;
    }
    nameInput.focus();
  }

  function closeSiteModal() {
    siteModal.style.display = 'none';
  }

  saveSiteBtn.addEventListener('click', () => {
    const name = nameInput.value.trim();
    const url  = urlInput.value.trim();
    const icon = iconInput.value.trim();
    if (!name || !url) return;

    const entry = { name, url, icon };
    if (editIndex !== null) {
      links[editIndex] = entry;
    } else {
      links.push(entry);
    }
    saveLinks();
    renderTiles();
    closeSiteModal();
  });

  cancelSiteBtn.addEventListener('click', closeSiteModal);

  window.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      if (siteModal.style.display === 'flex') closeSiteModal();
      if (editModal.style.display === 'flex') closeEditModal();
      ctxMenu.style.display = 'none';
    }
  });

  /* ------------------------------------------------------------------ */
  /*                     EDIT / DELETE / DRAGâ€‘DROP                      */
  /* ------------------------------------------------------------------ */
  window.editSite = idx => {
    const link = links[idx];
    nameInput.value = link.name;
    urlInput.value  = link.url;
    iconInput.value = link.icon || '';
    editIndex = idx;
    openSiteModal(true);
  };

  window.deleteSite = idx => {
    if (!confirm('Delete this tile?')) return;
    links.splice(idx, 1);
    saveLinks();
    renderTiles();
  };

  function dragStart(e) {
    dragStartIndex = +this.dataset.index;
    e.dataTransfer.effectAllowed = 'move';
  }

  function dragOver(e) {
    e.preventDefault();
    const overIndex = +this.dataset.index;
    if (dragStartIndex === overIndex) return;
    const [moved] = links.splice(dragStartIndex, 1);
    links.splice(overIndex, 0, moved);
    dragStartIndex = overIndex;
    saveLinks(); // persist order without reâ€‘rendering every pixelâ€‘move
  }

  function drop(e) {
    e.preventDefault();
    renderTiles();
  }

  /* ------------------------------------------------------------------ */
  /*                     GLOBAL SETTINGS MODAL                          */
  /* ------------------------------------------------------------------ */
  function openEditModal() {
    const { textColor = '#ffffff', tileColor = '#ffffff' } = getSettings();

    textColorInput.value = textColor;
    tileColorInput.value = rgbToHex(tileColor);

    editModal.style.display = 'flex';
  }

  function closeEditModal() {
    editModal.style.display = 'none';
  }

  editBtn.addEventListener('click', openEditModal);
  cancelSettingsBtn.addEventListener('click', closeEditModal);

  // Colour conversions =================================================
  const rgbaRegex = /rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/;
  const rgbToHex = rgba => {
    const parts = rgba.match(rgbaRegex);
    if (!parts) return '#ffffff';
    const toHex = n => (+n).toString(16).padStart(2, '0');
    return `#${toHex(parts[1])}${toHex(parts[2])}${toHex(parts[3])}`;
  };
  const hexToRgba = (hex, alpha = 0.4) => {
    const num = parseInt(hex.slice(1), 16);
    const r = (num >> 16) & 255;
    const g = (num >> 8) & 255;
    const b = num & 255;
    return `rgba(${r},${g},${b},${alpha})`;
  };

  // Background upload ==================================================
  bgFileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const dataUrl = ev.target.result;
      document.body.style.setProperty('--custom-bg', `url('${dataUrl}')`);
      const settings = getSettings();
      settings.customBackground = dataUrl;
      saveSettings(settings);
    };
    reader.readAsDataURL(file);
  });

  // Save settings ======================================================
  saveSettingsBtn.addEventListener('click', () => {
    const textColorHex = textColorInput.value;
    const tileColorHex = tileColorInput.value;

    const settings = getSettings();
    settings.textColor = textColorHex;
    settings.tileColor = hexToRgba(tileColorHex);
    saveSettings(settings);
    applySettings();
    closeEditModal();
  });

  /* ------------------------------------------------------------------ */
  /*                       EXPORT / IMPORT                              */
  /* ------------------------------------------------------------------ */
  exportBtn.addEventListener('click', () => {
    const data = {
      tiles: links,
      settings: getSettings()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'dashboard_state.json';
    a.click();

    URL.revokeObjectURL(url);
  });

  importBtn.addEventListener('click', () => importInput.click());

  importInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        if (!Array.isArray(data.tiles)) throw new Error('Invalid state file');

        links = data.tiles;
        saveLinks();

        if (data.settings) {
          saveSettings(data.settings);
        }
        location.reload();
      } catch (err) {
        alert('Error importing state: ' + err.message);
      }
    };
    reader.readAsText(file);
  });

  /* ------------------------------------------------------------------ */
  /*                      CONTEXT MENU                                  */
  /* ------------------------------------------------------------------ */
  let ctxIndex = null;

  container.addEventListener('contextmenu', e => {
    const tile = e.target.closest('.tile');
    if (!tile) return; // let browser handle elsewhere
    e.preventDefault();

    ctxIndex = +tile.dataset.index;
    ctxMenu.style.top  = `${e.clientY}px`;
    ctxMenu.style.left = `${e.clientX}px`;
    ctxMenu.style.display = 'block';
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('.context-menu')) ctxMenu.style.display = 'none';
  });

  ctxEditBtn.addEventListener('click', () => {
    if (ctxIndex !== null) window.editSite(ctxIndex);
    ctxMenu.style.display = 'none';
  });

  ctxDeleteBtn.addEventListener('click', () => {
    if (ctxIndex !== null) window.deleteSite(ctxIndex);
    ctxMenu.style.display = 'none';
  });

  /* ------------------------------------------------------------------ */
  /*                      INITIALISATION                                */
  /* ------------------------------------------------------------------ */
  applySettings();
  renderTiles();
})();
</script>

</body>
</html>
